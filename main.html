<!DOCTYPE html>
<html>
<head>
    <title>CG Final Project</title>
    <script src="https://preview.babylonjs.com/babylon.js"></script> <!-- import babylonjs -->
    <script src="https://preview.babylonjs.com/gui/babylon.gui.js"></script> <!-- GUI for babylonjs -->
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script> <!-- scene loaders -->
    <script src="https://code.jquery.com/pep/0.4.3/pep.js"></script> <!-- scene interactions -->
    
    <style>
        html, body
        {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #render
        {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <canvas id="render" touch-action="none"> <!-- canvas creation -->
    <script>
        var canvas = document.getElementById("render"); // initialise the canvas
        var engine = new BABYLON.Engine(canvas, true); // initialise the engine
        var createScene = function(){
            var scene = new BABYLON.Scene(engine); // the scene
            scene.gravity = new BABYLON.Vector3(0, -0.9, 0);
            scene.collisionsEnabled = true;

            var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene); // the light of the scene

            var camera1 = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 4, 25, new BABYLON.Vector3(0, 0, 0), scene); // viewing camera
            var camera2 = new BABYLON.UniversalCamera("camera_1person", new BABYLON.Vector3(0, 2, 0), scene);
            camera1.attachControl(canvas, true); // attach camera to canvas
            camera2.checkCollisions = true;
            camera2.applyGravity = true;

            var setArcCam = function(){
                scene.activeCamera = camera1;
                camera1.attachControl(canvas, true);
            };

            var setUniCam = function(){
                scene.activeCamera = camera2;
                camera2.attachControl(canvas, true);
            };

            camera2.ellipsoid = new BABYLON.Vector3(1, 1, 1);

            var gizmoManager = new BABYLON.GizmoManager(scene);
            gizmoManager.attachableMeshes = [];

            // create undeletable objects for walls and floors
            var undeletable_meshes = [];

            var map = {}; //object for multiple key presses
            scene.actionManager = new BABYLON.ActionManager(scene);

            scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, function (evt) {
                map[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
            }));
            
            scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, function (evt) {
                map[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
            }));

            var delete_item = false;
            var clone_item = false;

            scene.registerBeforeRender(function () {
                if ((map["z"] || map["Z"])) {
                    gizmoManager.positionGizmoEnabled = true;
                    gizmoManager.rotationGizmoEnabled = false;
                    gizmoManager.scaleGizmoEnabled = false;
                    gizmoManager.boundingBoxGizmoEnabled = false;
                    delete_item = false;
                    clone_item = false;
                };
                if ((map["x"] || map["X"])) {
                    gizmoManager.positionGizmoEnabled = false;
                    gizmoManager.rotationGizmoEnabled = true;
                    gizmoManager.scaleGizmoEnabled = false;
                    gizmoManager.boundingBoxGizmoEnabled = false;
                    delete_item = false;
                    clone_item = false;
                };
                if ((map["c"] || map["C"])) {
                    gizmoManager.positionGizmoEnabled = false;
                    gizmoManager.rotationGizmoEnabled = false;
                    gizmoManager.scaleGizmoEnabled = true;
                    gizmoManager.boundingBoxGizmoEnabled = true;
                    delete_item = false;
                    clone_item = false;
                };
                if (map["v"] || map["V"]) {
                    gizmoManager.positionGizmoEnabled = false;
                    gizmoManager.rotationGizmoEnabled = false;
                    gizmoManager.scaleGizmoEnabled = false;
                    gizmoManager.boundingBoxGizmoEnabled = false;
                    delete_item = false;
                    clone_item = true;
                }
                if (map["b"] || map["B"]){
                    gizmoManager.attachToMesh(null);
                    gizmoManager.positionGizmoEnabled = false;
                    gizmoManager.rotationGizmoEnabled = false;
                    gizmoManager.scaleGizmoEnabled = false;
                    gizmoManager.boundingBoxGizmoEnabled = false;
                    delete_item = false;
                    clone_item = false;
                };

                if (map["n"] || map["N"]) {
                    gizmoManager.attachToMesh(null);
                    gizmoManager.positionGizmoEnabled = false;
                    gizmoManager.rotationGizmoEnabled = false;
                    gizmoManager.scaleGizmoEnabled = false;
                    gizmoManager.boundingBoxGizmoEnabled = false;
                    delete_item = true;
                    clone_item = false;
                };
            });

            scene.onPointerDown = function(evt, pickResult) {
                if (pickResult.pickedMesh) {
                    if(!undeletable_meshes.includes(pickResult.pickedMesh) && delete_item == true){
                        pickResult.pickedMesh.dispose();
                    }
                    else if(clone_item == true){
                        newclone = pickResult.pickedMesh.clone();
                        newclone.makeGeometryUnique();
                        newclone.position = new BABYLON.Vector3(0,6,0);
                        gizmoManager.attachableMeshes.push(newclone);

                    }
                };
            };
		

            // materials for the mesh

            var wallmat1 = new BABYLON.StandardMaterial("wallmat1", scene); // brick material
	        wallmat1.diffuseTexture = new BABYLON.Texture("./materials/wallmat1.jpg", scene); // importing image for material

            var wallmat2 = new BABYLON.StandardMaterial("wallmat2", scene); // brick2 material
            wallmat2.diffuseTexture = new BABYLON.Texture("./materials/wallmat2.jpg", scene);

            var floormat1 = new BABYLON.StandardMaterial("floormat1", scene); // carpet material
            floormat1.diffuseTexture = new BABYLON.Texture("./materials/floormat1.jpg", scene);

            var floormat2 = new BABYLON.StandardMaterial("floormat2", scene); // wood floor material
            floormat2.diffuseTexture = new BABYLON.Texture("./materials/floormat2.jpg", scene);

            // options for the mesh builder

            var optground_a = {
                xmin: -10,
                zmin: -5,
                xmax: 10,
                zmax: 5,
                subdivisions: {h: 5, w: 10},
                precision: {h: 2, w: 2}
            }

            var optground_b = {
                xmin: -12,
                zmin: -12,
                xmax: 12,
                zmax: 12,
                subdivisions: {h: 12, w: 12},
                precision: {h: 2, w: 2}
            }

            var optwall_a1 = {
                sideOrientation: BABYLON.Mesh.DOUBLESIDE,
                pattern: BABYLON.Mesh.NO_FLIP,
                height: 4,
                width: 21,
                depth: 0.5,
                tileSize: 2
            }

            var optwall_a2 = {
                sideOrientation: BABYLON.Mesh.DOUBLESIDE,
                pattern: BABYLON.Mesh.NO_FLIP,
                height: 4,
                width: 10,
                depth: 0.5,
                tileSize: 2
            }

            var optwall_b1 = {
                sideOrientation: BABYLON.Mesh.DOUBLESIDE,
                pattern: BABYLON.Mesh.NO_FLIP,
                height: 4,
                width: 24,
                depth: 0.5,
                tileSize: 2
            }

            var optwall_b2 = {
                sideOrientation: BABYLON.Mesh.DOUBLESIDE,
                pattern: BABYLON.Mesh.NO_FLIP,
                height: 4,
                width: 25,
                depth: 0.5,
                tileSize: 2
            }

            var optwall_b3 = {
                sideOrientation: BABYLON.Mesh.DOUBLESIDE,
                pattern: BABYLON.Mesh.NO_FLIP,
                height: 4,
                width: 11.75,
                depth: 0.5,
                tileSize: 2
            }

            var ground_a = new BABYLON.MeshBuilder.CreateTiledGround("ground_a", optground_a, scene); // create the ground
            ground_a.material = floormat1;

            var ground_b = new BABYLON.MeshBuilder.CreateTiledGround("ground_b", optground_b, scene);
            ground_b.material = floormat1;
            
            var wall_a1 = new BABYLON.MeshBuilder.CreateTiledBox("wall_a1", optwall_a1, scene); // create the wall for the ground to make room
            wall_a1.position = new BABYLON.Vector3(0, 2, 5.25);
            wall_a1.material = wallmat1;
            
            var wall_a2 = new BABYLON.MeshBuilder.CreateTiledBox("wall_a2", optwall_a2, scene); // wall for room
            wall_a2.position = new BABYLON.Vector3(10.25, 2, 0);
            wall_a2.rotation.y = Math.PI / 2;
            wall_a2.material = wallmat1;
            
            var wall_a3 = new BABYLON.MeshBuilder.CreateTiledBox("wall_a3", optwall_a1, scene); // wall for room
            wall_a3.position = new BABYLON.Vector3(0, 2, -5.25);
            wall_a3.material = wallmat1;

            var wall_a4 = new BABYLON.MeshBuilder.CreateTiledBox("wall_a4", optwall_a2, scene) // wall for room
            wall_a4.position = new BABYLON.Vector3(-10.25, 2, 0);
            wall_a4.rotation.y -= Math.PI / 2;
            wall_a4.material = wallmat1;

            var wall_b1 = new BABYLON.MeshBuilder.CreateTiledBox("wall_b1", optwall_b1, scene);
            wall_b1.position = new BABYLON.Vector3(0, 2, 12.25);
            wall_b1.material = wallmat1;

            var wall_b2 = new BABYLON.MeshBuilder.CreateTiledBox("wall_b2", optwall_b2, scene);
            wall_b2.position = new BABYLON.Vector3(12.25, 2, 0);
            wall_b2.rotation.y = Math.PI / 2;
            wall_b2.material = wallmat1;

            var wall_b3 = new BABYLON.MeshBuilder.CreateTiledBox("wall_b3", optwall_b1, scene);
            wall_b3.position = new BABYLON.Vector3(0, 2, -12.25);
            wall_b3.material = wallmat1;

            var wall_b4 = new BABYLON.MeshBuilder.CreateTiledBox("wall_b4", optwall_b2, scene);
            wall_b4.position = new BABYLON.Vector3(-12.25, 2, 0);
            wall_b4.rotation.y -= Math.PI / 2;
            wall_b4.material = wallmat1;

            var wall_b5 = new BABYLON.MeshBuilder.CreateTiledBox("wall_b5", optwall_b1, scene);
            wall_b5.position = new BABYLON.Vector3(0, 2, 0);
            wall_b5.material = wallmat1;
            
            var wall_b6 = new BABYLON.MeshBuilder.CreateTiledBox("wall_b6", optwall_b3, scene);
            wall_b6.position = new BABYLON.Vector3(0, 2, 6.125);
            wall_b6.rotation.y -= Math.PI / 2;
            wall_b6.material = wallmat1;

            ground_a.checkCollisions = true;
            wall_a1.checkCollisions = true;
            wall_a2.checkCollisions = true;
            wall_a3.checkCollisions = true;
            wall_a4.checkCollisions = true;
            undeletable_meshes.push(ground_a);
            undeletable_meshes.push(wall_a1);
            undeletable_meshes.push(wall_a2);
            undeletable_meshes.push(wall_a3);
            undeletable_meshes.push(wall_a4);

            ground_b.isVisible = false;
            wall_b1.isVisible = false;
            wall_b2.isVisible = false;
            wall_b3.isVisible = false;
            wall_b4.isVisible = false;
            wall_b5.isVisible = false;
            wall_b6.isVisible = false;
            undeletable_meshes.push(ground_b);
            undeletable_meshes.push(wall_b1);
            undeletable_meshes.push(wall_b2);
            undeletable_meshes.push(wall_b3);
            undeletable_meshes.push(wall_b4);
            undeletable_meshes.push(wall_b5);
            undeletable_meshes.push(wall_b6);

            /* BABYLON.SceneLoader.ImportMesh("", "./chair/", "chair.obj", scene, function(newMeshes){
                var chair = newMeshes[0];
                chair.position = new BABYLON.Vector3(5, 0.5, 0);
                chair.rotation.y = Math.PI;
            }); */

            /* BABYLON.SceneLoader.ImportMesh("", "./wooden-coffe-table/", "wooden-coffe-table.babylon", scene, function(newMeshes){
                table = newMeshes[0];
                table.position = new BABYLON.Vector3(4, 0, 0);
                // table.scaling = new BABYLON.Vector3(0.5, 0.5, 0.5);
            }); */

            // GUI
             
            var ui = new BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI", true, scene); // create the base ui

            var wallmaster = new BABYLON.GUI.Button.CreateSimpleButton("wall_button_master", "Show wall");

            var wall_but1 = new BABYLON.GUI.Button.CreateImageOnlyButton("wall_button", "./materials/wallmat1.jpg"); // create button
            wall_but1.width = "70px";
            wall_but1.height = "70px";
            wall_but1.color = "#000000";
            wall_but1.background = "#ffffff";
            wall_but1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            wall_but1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            wall_but1.left = "10px";
            wall_but1.top = "-120px";
            wall_but1.onPointerUpObservable.add(function(){
                wall_a1.material = wallmat1;
                wall_a2.material = wallmat1;
                wall_a3.material = wallmat1;
                wall_a4.material = wallmat1;
            });

            var wall_but2 = new BABYLON.GUI.Button.CreateImageOnlyButton("wall_button2", "./materials/wallmat2.jpg");
            wall_but2.width = "70px";
            wall_but2.height = "70px";
            wall_but2.color = "#000000";
            wall_but2.background = "#ffffff";
            wall_but2.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            wall_but2.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            wall_but2.left = "90px";
            wall_but2.top = "-120px";
            wall_but2.onPointerUpObservable.add(function(){
                wall_a1.material = wallmat2;
                wall_a2.material = wallmat2;
                wall_a3.material = wallmat2;
                wall_a4.material = wallmat2;
            });

            var floor_but1 = new BABYLON.GUI.Button.CreateImageOnlyButton("floor_button", "./materials/floormat1.jpg");
            floor_but1.width = "70px";
            floor_but1.height = "70px";
            floor_but1.color = "#000000";
            floor_but1.background = "#ffffff";
            floor_but1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            floor_but1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            floor_but1.left = "10px";
            floor_but1.top = "-20px";
            floor_but1.onPointerUpObservable.add(function(){ 
                ground_a.material = floormat1;
            });

            var floor_but2 = new BABYLON.GUI.Button.CreateImageOnlyButton("floor_button2", "./materials/floormat2.jpg");
            floor_but2.width = "70px";
            floor_but2.height = "70px";
            floor_but2.color = "#000000";
            floor_but2.background = "#ffffff";
            floor_but2.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            floor_but2.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            floor_but2.left = "90px";
            floor_but2.top = "-20px";
            floor_but2.onPointerUpObservable.add(function(){ 
                ground_a.material = floormat2;
            });

            var chair_add = new BABYLON.GUI.Button.CreateSimpleButton("chair_add", "Add chair");
            chair_add.width = "70px";
            chair_add.height = "70px";
            chair_add.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
            chair_add.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            chair_add.left = "-90px";
            chair_add.top = "-120px";
            chair_add.onPointerUpObservable.add(function(){
                BABYLON.SceneLoader.ImportMesh(null, "./furnitures/bedroom/chair/", "chair.obj", scene, function(meshes) {
                    var chair = meshes[0];

                    chair = BABYLON.Mesh.MergeMeshes(meshes, true, true, undefined, false, true)
                    chair.position = new BABYLON.Vector3(0,6,0);                    
                    chair.checkCollisions = true;
                    chair.isPickable = true;
                    gizmoManager.attachableMeshes.push(chair);
                });
            });

            var table_add = new BABYLON.GUI.Button.CreateSimpleButton("table_add", "Add table");
            table_add.width = "70px";
            table_add.height = "70px";
            table_add.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
            table_add.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            table_add.left = "-10px";
            table_add.top = "-120px";
            table_add.onPointerUpObservable.add(function(){
                BABYLON.SceneLoader.ImportMesh(null, "./furnitures/livingroom/sofa/", "sofa.obj", scene, function(meshes) {
                    var table = meshes[0];

                    table = BABYLON.Mesh.MergeMeshes(meshes, true, true, undefined, false, true)
                    table.checkCollisions = true;

                    table.scaling = new BABYLON.Vector3(0.01, 0.01, 0.01);
                    table.position = new BABYLON.Vector3(0,6,0);
                    gizmoManager.attachableMeshes.push(table);
                });
            });

            var cam_uni = new BABYLON.GUI.Button.CreateSimpleButton("camera_uni", "First person view");
            cam_uni.width = "200px";
            cam_uni.height = "35px";
            cam_uni.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            cam_uni.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            cam_uni.left = "230px";
            cam_uni.top = "10px";
            cam_uni.onPointerUpObservable.add(function(){
                setUniCam();
                cam_arc.isVisible = true;
                cam_uni.isVisible = false;
            });

            var cam_arc = new BABYLON.GUI.Button.CreateSimpleButton("camera_arc", "Third person view");
            cam_arc.width = "200px";
            cam_arc.height = "35px";
            cam_arc.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            cam_arc.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            cam_arc.left = "230px";
            cam_arc.top = "10px";
            cam_arc.onPointerUpObservable.add(function(){
                setArcCam();
                cam_arc.isVisible = false;
                cam_uni.isVisible = true;
            });

            var room_a = new BABYLON.GUI.Button.CreateSimpleButton("swap_scene_a", "Scene A");
            room_a.width = "70px";
            room_a.height = "70px";
            room_a.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
            room_a.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            room_a.left = "-90px";
            room_a.top = "10px";
            room_a.onPointerUpObservable.add(function(){
                if (confirm('Are you sure you want to change to scene A? Any unsaved changes will be lost!')) {
                    ground_a.isVisible = true;
                    wall_a1.isVisible = true;
                    wall_a2.isVisible = true;
                    wall_a3.isVisible = true;
                    wall_a4.isVisible = true;

                    ground_b.isVisible = false;
                    wall_b1.isVisible = false;
                    wall_b2.isVisible = false;
                    wall_b3.isVisible = false;
                    wall_b4.isVisible = false;
                    wall_b5.isVisible = false;
                    wall_b6.isVisible = false;
                    for (var i = 0; i < gizmoManager.attachableMeshes.length; i++) {
                        gizmoManager.attachableMeshes[i].dispose();
                    }
                }
            });

            var room_b = new BABYLON.GUI.Button.CreateSimpleButton("swap_scene_b", "Scene B");
            room_b.width = "70px";
            room_b.height = "70px";
            room_b.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
            room_b.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            room_b.left = "-10px";
            room_b.top = "10px";
            room_b.onPointerUpObservable.add(function(){
                if (confirm('Are you sure you want to change to scene B? Any unsaved changes will be lost!')) {
                    ground_a.isVisible = false;
                    wall_a1.isVisible = false;
                    wall_a2.isVisible = false;
                    wall_a3.isVisible = false;
                    wall_a4.isVisible = false;

                    ground_b.isVisible = true;
                    wall_b1.isVisible = true;
                    wall_b2.isVisible = true;
                    wall_b3.isVisible = true;
                    wall_b4.isVisible = true;
                    wall_b5.isVisible = true;
                    wall_b6.isVisible = true;
                    for (var i = 0; i < gizmoManager.attachableMeshes.length; i++) {
                        gizmoManager.attachableMeshes[i].dispose();
                    }
                }
            });

            // save scene button
            var save_scene = new BABYLON.GUI.Button.CreateSimpleButton("save_scene", "Save Scene");
            save_scene.width = "100px";
            save_scene.height = "35px";
            save_scene.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            save_scene.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            save_scene.left = "10px";
            save_scene.top = "10px";
            save_scene.onPointerUpObservable.add(function(){
                if (confirm('Do you want to download that scene?')) {
                        download_scene('scene.babylon', scene);
                }
            });

            // upload item button
            var upload_item = new BABYLON.GUI.Button.CreateSimpleButton("upload_item", "Upload Item");
            upload_item.width = "100px";
            upload_item.height = "35px";
            upload_item.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            upload_item.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            upload_item.left = "120px";
            upload_item.top = "10px";
            upload_item.onPointerUpObservable.add(function(evt){
                
                // create input_form 
                var input_form = window.document.createElement('input');
                input_form.type = "file";
                input_form.id = "files";
                
                // create file handler function
                function handle_file(evt) {

                    // get file from form
                    var files = evt.target.files;

                    // create a temporary URL for file
                    var tmp_path = URL.createObjectURL(files[0]);
                    console.log(tmp_path);
                    // append file
                    BABYLON.SceneLoader.ImportMesh(null, "",tmp_path, scene, function(meshes) {
                        
                        var mesh = meshes[0];
                        
                        console.log(meshes);
                        try{
                            // merge the mesh into one
                            mesh = BABYLON.Mesh.MergeMeshes(meshes, true, true, undefined, false, true);
                            
                        }
                        catch(error){
                            console.log(error);
                        }
                        mesh.checkCollisions = true;
                        mesh.position = new BABYLON.Vector3(0,6,0);
                        gizmoManager.attachableMeshes.push(mesh);
                    });
                
                    
                }
                // set listener onto file uploader
                input_form.addEventListener('change', handle_file, false);

                // create click event to click the input_form
                var click = document.createEvent("MouseEvents");
                click.initEvent("click", true, false);
                input_form.dispatchEvent(click);
                
            });

            ui.addControl(wall_but1);
            ui.addControl(wall_but2);
            ui.addControl(floor_but1);
            ui.addControl(floor_but2);
            ui.addControl(chair_add);
            ui.addControl(table_add);
            ui.addControl(cam_uni);
            ui.addControl(cam_arc);
            ui.addControl(room_a);
            ui.addControl(room_b);
            ui.addControl(save_scene);
            ui.addControl(upload_item);

            cam_arc.isVisible = false;

            return scene;
        };

        var downloadUrl;
        function download_scene(filename, scene) {
            // delete download url if it exists
            if(downloadUrl) {
                window.URL.revokedownloadUrl(downloadUrl);
            }

            // serializer scene
            var serializedScene = BABYLON.SceneSerializer.Serialize(scene);

            // convert serialized scene into string
            var strScene = JSON.stringify(serializedScene);

            // create a blob from the string
            var blob = new Blob ( [ strScene ], { type : "octet/stream" } );

            // turn blob into an object URL
            downloadUrl = window.URL.createObjectURL(blob);

            // create download element
            var link = window.document.createElement('a');
            link.href = downloadUrl;
            link.download = filename;

            // create click event to click the link
            var click = document.createEvent("MouseEvents");
            click.initEvent("click", true, false);
            link.dispatchEvent(click);          
        }

        var scene = createScene(); // scene displaying goes here...

        engine.runRenderLoop(function(){ // renders the scene via loop
            scene.render();
        });

        window.addEventListener("resize", function(){
            engine.resize();
        });
    </script>
</body>
</html>